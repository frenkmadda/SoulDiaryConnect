<!DOCTYPE html>
{%  load static %}
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Paziente - SoulDiaryConnect</title>
    <link rel="stylesheet" href="{% static 'SoulDiaryConnectApp/css/paziente_home.css' %}">
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="/media/2-01.png" alt="SoulDiaryConnect">
            <h1>Benvenuto, {{ paziente.nome }} {{ paziente.cognome }}</h1>
        </div>
        <a href="{% url 'logout' %}" class="logout-btn">
            Logout
            <img src="/media/logout_white.png" alt="">
        </a>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h2>
                <img src="/media/stethoscope.png" alt="">
                Il tuo medico
            </h2>

            <div class="doctor-card">
                <p><strong>Nome:</strong> {{ medico.nome }} {{ medico.cognome }}</p>
                <p><strong>Indirizzo:</strong> {{ medico.indirizzo_studio }}, {{ medico.numero_civico }} - {{ medico.citta }}</p>
                <p><strong>Email:</strong> {{ medico.email }}</p>
                <p><strong>Tel. Studio:</strong> {{ medico.numero_telefono_studio }}</p>
                <p><strong>Tel. Cellulare:</strong> {{ medico.numero_telefono_cellulare }}</p>
            </div>

            <div class="divider"></div>

            <div class="add-note-section">
                <h2>Aggiungi una nuova nota</h2>
                <form method="POST" id="addNoteForm" onsubmit="showLoadingModal()">
                    {% csrf_token %}
                    <div class="textarea-container">
                        <textarea name="desc" id="notaTextarea" placeholder="Scrivi qui i tuoi pensieri o usa la registrazione vocale..." rows="8" required></textarea>
                        <button type="button" id="voiceBtn" class="voice-btn" onclick="toggleVoiceRecording()" title="Registrazione vocale">
                            <svg id="micIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                    </div>
                    <div id="recordingStatus" class="recording-status" style="display:none;">
                        <span class="recording-pulse"></span>
                        <span class="recording-text">Sto ascoltando...</span>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" name="generateResponse" id="generateResponse">
                        <label for="generateResponse">Genera automaticamente frasi di supporto</label>
                    </div>

                    <button type="submit" class="submit-btn">Aggiungi Nota</button>
                </form>
            </div>
        </div>

        <div class="notes-section">
            <h2>
                <img src="/media/writing.png" alt="">
                Le tue note diario
            </h2>

            {% if note_diario %}
                {% for nota in note_diario %}
                    <div class="note-card">
                        <p><strong>Data:</strong> {{ nota.data_nota|date:"d/m/Y" }}</p>
                        <p><strong>Nota:</strong> {{ nota.testo_paziente }}</p>

                        {% if nota.testo_supporto %}
                            <div class="note-separator"></div>
                            <div class="support-text">
                                <p><strong>üíô Supporto:</strong> {{ nota.testo_supporto }}</p>
                            </div>
                        {% endif %}

                        {% if nota.testo_medico or nota.testo_medico == "None" %}
                            <div class="note-separator"></div>
                            <div class="doctor-comment">
                                <p><strong>ü©∫ Cosa ne pensa il medico:</strong> {{ nota.testo_medico }}</p>
                            </div>
                        {% endif %}
                        <button type="button" class="delete-btn" 
    data-id="{{ nota.id }}" 
    data-data="{{ nota.data_nota|date:'d/m/Y'|escapejs }}" 
    data-nota="{{ nota.testo_paziente|escapejs }}" 
    onclick="openDeleteModalFromButton(this)" 
    style="background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;margin-top:10px;">
    Elimina
</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>Non ci sono ancora note disponibili.</p>
                    <p>Inizia a scrivere il tuo diario!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal di conferma eliminazione -->
    <div id="deleteModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2 style="color:#dc3545;">Conferma eliminazione</h2>
            <p id="modalData"></p>
            <p id="modalNota"></p>
            <form method="POST" id="deleteForm">
                {% csrf_token %}
                <button type="submit" class="submit-btn" style="background:#dc3545;">Elimina definitivamente</button>
                <button type="button" class="submit-btn" style="background:#6c757d;margin-left:12px;" onclick="closeDeleteModal()">Annulla</button>
            </form>
        </div>
    </div>

    <!-- Modal di caricamento -->
    <div id="loadingModal" class="modal-overlay loading-modal" style="display:none;">
        <div class="modal-content">
            <div class="note-icon">üìù</div>
            <h2>Generazione nota in corso...</h2>
            <p style="color: #475569; font-size: 15px;">Stiamo elaborando la tua nota e generando il supporto personalizzato</p>
            <div class="loading-animation">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <script>
        // Variabili per la registrazione vocale
        let recognition = null;
        let isRecording = false;

        // Inizializza il riconoscimento vocale
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();

                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'it-IT';

                recognition.onstart = function() {
                    console.log('Registrazione avviata');
                    isRecording = true;
                    updateRecordingUI(true);
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + ' ';
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    const textarea = document.getElementById('notaTextarea');
                    const currentText = textarea.value;

                    // Se ci sono risultati finali, aggiungili al testo
                    if (finalTranscript) {
                        // Rimuovi l'ultima trascrizione provvisoria e aggiungi quella finale
                        const baseText = currentText.replace(/\[Ascoltando\.\.\.].*$/, '').trim();
                        textarea.value = baseText + (baseText ? ' ' : '') + finalTranscript.trim();
                    } else if (interimTranscript) {
                        // Mostra la trascrizione provvisoria
                        const baseText = currentText.replace(/\[Ascoltando\.\.\.].*$/, '').trim();
                        textarea.value = baseText + (baseText ? ' ' : '') + '[Ascoltando...] ' + interimTranscript;
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Errore nel riconoscimento vocale:', event.error);
                    if (event.error === 'no-speech') {
                        console.log('Nessun parlato rilevato');
                    } else if (event.error === 'not-allowed') {
                        alert('Permesso microfono negato. Per favore, abilita il microfono nelle impostazioni del browser.');
                        isRecording = false;
                        updateRecordingUI(false);
                    }
                };

                recognition.onend = function() {
                    console.log('Registrazione terminata');
                    if (isRecording) {
                        // Riavvia se dovrebbe essere ancora in registrazione
                        recognition.start();
                    } else {
                        updateRecordingUI(false);
                        // Pulisci eventuali marcatori provvisori
                        const textarea = document.getElementById('notaTextarea');
                        textarea.value = textarea.value.replace(/\[Ascoltando\.\.\.].\s*/g, '').trim();
                    }
                };
            } else {
                console.error('API di riconoscimento vocale non supportata');
                alert('Il riconoscimento vocale non √® supportato dal tuo browser. Prova ad usare Chrome o Edge.');
            }
        }

        function toggleVoiceRecording() {
            if (!recognition) {
                initSpeechRecognition();
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Errore avvio registrazione:', e);
                }
            }
        }

        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
        }

        function updateRecordingUI(recording) {
            const voiceBtn = document.getElementById('voiceBtn');
            const recordingStatus = document.getElementById('recordingStatus');

            if (recording) {
                voiceBtn.classList.add('recording');
                recordingStatus.style.display = 'flex';
            } else {
                voiceBtn.classList.remove('recording');
                recordingStatus.style.display = 'none';
            }
        }

        function showLoadingModal() {
            // Ferma la registrazione se attiva
            if (isRecording) {
                stopRecording();
            }
            // Mostra il modal di caricamento
            document.getElementById('loadingModal').style.display = 'flex';
            // Permetti l'invio del form
            return true;
        }

        function openDeleteModalFromButton(btn) {
            var notaId = btn.getAttribute('data-id');
            var dataNota = btn.getAttribute('data-data');
            var testoNota = btn.getAttribute('data-nota');
            openDeleteModal(notaId, dataNota, testoNota);
        }
        function openDeleteModal(notaId, dataNota, testoNota) {
            document.getElementById('modalData').innerHTML = '<strong>Data:</strong> ' + dataNota;
            document.getElementById('modalNota').innerHTML = '<strong>Nota:</strong> ' + testoNota;
            var form = document.getElementById('deleteForm');
            form.action = '/paziente/note/' + notaId + '/elimina/';
            document.getElementById('deleteModal').style.display = 'flex';
        }
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }
    </script>
</body>
</html>