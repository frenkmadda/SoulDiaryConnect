<!DOCTYPE html>
{% load static %}
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home Medico - SoulDiaryConnect</title>
    <link rel="stylesheet" href="{% static 'SoulDiaryConnectApp/css/medico_home.css' %}?v=2.1">
  <!-- Libreria per parsing Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    function selectPatient(selectedButton){
      const buttons = document.querySelectorAll('.patient-btn');
      buttons.forEach(btn => btn.classList.remove('selected'));
      selectedButton.classList.add('selected');
    }

    function rigeneraFraseClinica(notaId, btn) {
      // Mostra il modal di caricamento
      const modal = document.getElementById('loadingModal');
      if (modal) {
        console.log('Modal trovato, lo mostro');
        modal.style.display = 'flex';
      } else {
        console.error('Modal non trovato!');
      }

      btn.disabled = true;
      btn.textContent = 'Rigenerazione...';

      fetch('{% url "rigenera_frase_clinica" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'nota_id=' + notaId
      })
      .then(response => response.json())
      .then(data => {
        // Nascondi il modal di caricamento
        if (modal) {
          modal.style.display = 'none';
        }

        if (data.testo_clinico) {
          document.getElementById('testo-clinico-' + notaId).innerHTML = marked.parse(data.testo_clinico);
        } else {
          alert(data.error || 'Errore nella rigenerazione.');
        }
        btn.disabled = false;
        btn.textContent = 'üîÑ Rigenera frase clinica';
      })
      .catch(() => {
        // Nascondi il modal di caricamento anche in caso di errore
        if (modal) {
          modal.style.display = 'none';
        }

        alert('Errore di rete.');
        btn.disabled = false;
        btn.textContent = 'üîÑ Rigenera frase clinica';
      });
    }
  </script>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <img src="/media/2-01.png" alt="SoulDiaryConnect">
      <h1>Benvenuto, Dr. {{ medico.nome }} {{ medico.cognome }} [Codice ID: {{ medico.codice_identificativo }}]</h1>
    </div>
    <div class="header-actions">
      <a href="{% url 'personalizza_generazione' %}" class="settings-btn">
        <img src="/media/settings2.png" alt=""> Personalizza
      </a>
      <a href="{% url 'logout' %}" class="logout-btn">
        Logout <img src="/media/logout_white.png" alt="">
      </a>
    </div>
  </div>

  <div class="main-container">
    <!-- SIDEBAR SINISTRA -->
    <div class="patients-sidebar">
      <h2>Lista Pazienti</h2>
      <div class="patients-list">
        {% for paziente in pazienti %}
          <button
            onclick="selectPatient(this); location.href='?paziente_id={{ paziente.codice_fiscale }}'"
            class="patient-btn {% if paziente_selezionato.codice_fiscale == paziente.codice_fiscale %}selected{% endif %}">
            {{ paziente.nome }} {{ paziente.cognome }}
          </button>

          {# ‚Äî‚Äî‚Äî NUOVO BOX DETTAGLI: appare sotto il paziente selezionato ‚Äî‚Äî‚Äî #}
          {% if paziente_selezionato and paziente_selezionato.codice_fiscale == paziente.codice_fiscale %}
            <div class="patient-mini-card">
              <h3>Dati del Paziente</h3>
              <p><strong>Nome:</strong> {{ paziente_selezionato.nome }} {{ paziente_selezionato.cognome }}</p>
              <p><strong>Codice Fiscale:</strong> {{ paziente_selezionato.codice_fiscale }}</p>
              <p><strong>Data di Nascita:</strong> {{ paziente_selezionato.data_di_nascita|date:"d/m/Y" }}</p>

              <a href="{% url 'analisi_paziente' %}?paziente_id={{ paziente_selezionato.codice_fiscale }}" class="analisi-btn">
                üìä Analisi
              </a>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="divider"></div>
      {# qui puoi aggiungere altri controlli lato sidebar, se servono #}
    </div>

    <!-- CONTENUTO DESTRO: SOLO NOTE -->
    <div class="content-area">
      <div class="notes-section">
        <h2>Note Diario del Paziente</h2>
        {% if paziente_selezionato %}
          {% if note_diario %}
            {% for nota in note_diario %}
              <div class="note-card">
                <div class="note-header">
                  <p><strong>üìÖ Data:</strong> {{ nota.data_nota|date:"d/m/Y" }} alle ore {{ nota.data_nota|date:"H:i" }}</p>
                  {% if nota.emozione_predominante %}
                    <div class="emotion-box emotion-{{ nota.emotion_category }}">
                      <span class="emotion-emoji">{{ nota.emoji }}</span>
                      <span class="emotion-text">{{ nota.emozione_predominante|capfirst }}</span>
                    </div>
                  {% endif %}
                </div>

                <p><strong>üìù Nota del paziente:</strong> {{ nota.testo_paziente }}</p>

                {% if nota.testo_supporto %}
                  <div class="note-separator"></div>
                  <p><strong>üíô Supporto automatico:</strong> {{ nota.testo_supporto }}</p>
                {% endif %}

                {% if nota.testo_clinico %}
                  <div class="note-separator"></div>
                  <div class="clinical-text">
                    <p>
                      <button type="button" class="rigenerate-btn" onclick="rigeneraFraseClinica({{ nota.id }}, this)">üîÑ Rigenera frase clinica</button>
                    </p>
                    <p><strong>üî¨ Analisi clinica:</strong></p>
                    <div id="testo-clinico-{{ nota.id }}" class="markdown-content">{{ nota.testo_clinico }}</div>
                  </div>
                {% endif %}
                <form method="POST" action="{% url 'modifica_testo_medico' nota.id %}" class="doctor-response-form">
                  {% csrf_token %}
                  <label>ü©∫ Il tuo commento professionale:</label>
                  <textarea name="testo_medico" rows="4">{% if nota.testo_medico %}{{ nota.testo_medico }}{% endif %}</textarea>
                  <button type="submit" class="save-btn">Salva Commento</button>
                </form>
              </div>

            {% endfor %}
          {% else %}
            <div class="empty-state">
              <p>Non ci sono note disponibili per questo paziente.</p>
            </div>

          {% endif %}
        {% else %}
          <div class="empty-state">

            <p>Seleziona un paziente dalla lista per visualizzare le note.</p>
          </div>
        {% endif %}

      </div>
    </div>
  </div>

  <!-- Modal di caricamento per rigenerazione frase clinica -->
  <div id="loadingModal" class="modal-overlay loading-modal" style="display:none;">
    <div class="modal-content">
      <div class="note-icon">üî¨</div>
      <h2>Rigenerazione analisi clinica...</h2>
      <p style="color: #475569; font-size: 15px;">Stiamo generando una nuova analisi</p>
      <div class="loading-animation">
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
      </div>
    </div>
  </div>

  <script>
    // Renderizza markdown per tutte le note cliniche al caricamento
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.markdown-content').forEach(function(el) {
        el.innerHTML = marked.parse(el.textContent || el.innerText);
      });
    });
  </script>
</body>
</html>
